version: '3.3'
services:
  postgres:
    image: postgres:14.5-alpine3.16
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=!admin!
      - POSTGRES_DB=admin
      #- PGDATA=/var/lib/postgresql/data/pgdata
      #- POSTGRES_DB=metastore
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/postgres-init.sql:/docker-entrypoint-initdb.d/postgres-init.sql:ro
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 500M
  metastore:
    #image: hive-metastore:3.1.3
    build: ./metastore
    container_name: metastore
    ports:
      - "9083:9083"
    volumes:
      - ./metastore/metastore-site.xml:/usr/local/metastore/conf/metastore-site.xml:ro
    logging:
      options:
        max-size: "5MB"
        max-file: "5"
    depends_on:
        - postgres


  minio:
    image: minio/minio:RELEASE.2024-09-09T16-59-28Z
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    environment:
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123
    command: server /data --console-address ":9001"
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G

  trino-coordinator:
    image: "trinodb/trino:457"
    ports:
      - '5542:5542'
    volumes:
      - ./trino/coordinator/etc:/etc/trino:ro
      - trino-coordinator-data:/data/trino
    depends_on:
      - metastore
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 3G

  trino-worker:
    image: "trinodb/trino:457"
    volumes:
      - ./trino/worker/etc:/etc/trino:ro
      - trino-worker-data:/data/trino
    depends_on:
      - metastore
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: "1.0"
          memory: 6G

  superset:
    build: ./superset
    ports:
      - "8088:8088"
    volumes:
      - superset-data:/app/superset_home
    environment:
      - SUPERSET_SECRET_KEY=24865129682968Aa!
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
volumes:
  minio-data:
    driver: local
  postgres-data:
    driver: local
  superset-data:
    driver: local
  trino-worker-data:
    driver: local
  trino-coordinator-data:
    driver: local
